---
title: "Osa data exploration"
output:
  html_document:
    toc: yes
    df_print: paged
  html_notebook:
    toc: yes
    code_folding: hide
    theme: spacelab
    fig_caption: yes
editor_options:
  chunk_output_type: console
---

```{r setup}
knitr::opts_chunk$set(
  echo = F,
  message = F,
  warning = F,
  collapse = T
  )
library(here)
#.GlobalEnv::
source(
  here("analysis/statsTbl.R")
  )
```

# Results

## Shade, biomass, *diversity*

```{r get}
mainModel <- median ~ dist
plotResultsTbl <- plotVarsTbl %>%
  getStatsTbl(
    mainModel
  )
```


```{r table}
plotSignifTbl <- plotResultsTbl %>%
  select(
    variable,
    isSignif,
    isSignif9,
    R2adj,
    graph
  ) %>%
  filter(
    isSignif == T |
      isSignif9 == T
  )
plotSignifTbl
```

```{r plots}
plotSignifTbl %>%
  pull(
    graph
    )
#buggyLabel
#ggarrange(.[[1]], .[[2]]) #buggy
```

-   spg et al. vars at tree or plot level? i think plot level.
-   richness, entropy [+spg] signif
- but why reverse relationships from each other?

- check curve below

```{r get2}
mainModel2 <- median ~ poly(
  dist,
  2
  )
plotResultsTbl2 <- plotVarsTbl %>%
  getStatsTbl2(
  mainModel2
) %>% 
  addGraph2(
    mainModel
  )
```

```{r table2}
plotSignifTbl2 <- plotResultsTbl2 %>%
  select(
    variable,
    curveName,
    pvals,
    R2adj,
    isSignif2,
    graph2
  ) %>%
  unnest(
    c(
      curveName,
      pvals,
      isSignif2
    )
  ) %>%
  filter(
    isSignif2 == T
  )
plotSignifTbl2
```

```{r plots2}
plotSignifTbl2 %>%
  pull(
    #buggylabel
    graph2
  )
```


- higher medians below

```{r get1}
plotResultsTbl1 <- plotVarsTbl %>%
  getStatsTbl1(
    mainModel
  )
```

```{r table1}
plotSignifTbl1 <- plotResultsTbl1 %>%
  select(
    variable,
    isSignif,
    graph
  ) %>%
  filter(
    isSignif == T
  )
plotSignifTbl1
```

```{r plots1}
plotSignifTbl1 %>%
  pull(
    graph
    )
```

- check curve below

```{r get12}
mainModel2 <- median ~ poly(
  dist,
  2
  )
plotResultsTbl12 <- plotVarsTbl %>%
  getStatsTbl12(
  mainModel2
) %>%
  addGraph12(
    mainModel
  )
```

```{r table12}
plotSignifTbl12 <- plotResultsTbl12 %>%
  select(
    variable,
    curveName,
    pvals,
    isSignif2,
    graph2
  ) %>%
  unnest(
    c(
      curveName,
      pvals,
      isSignif2
    )
  ) %>%
  filter(
    isSignif2 == T
  )
plotSignifTbl12
```

```{r plots12}
plotSignifTbl12 %>%
  pull(
    #buggylabel
    graph2
  )
```

-   spg appears signif--explanation will be relevant
-   explore historgrams for non-sig vars? (i.e. non-equilibrium stats)


## Composition


```{r ordination}
ordStat

ordVarTbl <- getOrdVarTbl(
  commTbl,
  metaTbl
)
```

```{r ordigraph}
ordVarTbl %>%
  ggplot(
    aes(
      x = PC1,
      y = PC2,
      color = as_factor(
        dist
      )
    )
  ) +
  geom_point() +
  stat_ellipse()

#library(ggvegan)
```

- which species cause this diff?


```{r taxa, eval = F}
# plan:
# - nest original data tbl by genus
# - varData = dist & count
# - run env::getStatsTbl()

taxModel <- n ~ dist

spStatTbl %>%
  getStatsTbl(
    taxModel
  )

d = spStatTbl %>% 
  statFitTbl(taxModel) %>%
  addStatEval(taxModel) %>%
  pull(
    statPrint,
    # isModelOK
  )
```


# Discussion

-   spg and richness change likely reflects shift in community (--\> add NMDS/PCoA, with closer plots dominated by pioneering species in dense stands
-   i think inference about dispersal strategies could be in discussion, or later figure, no need to be oriiginally embedded in analysis -- but would probably make story more ecological, and study more unique to present, though


# Appendix + some dependencies

- check curved relationships below

```{r tryNLS, eval = F}
start <- plotVarsTbl$varData[[1]] %>%
  select(
    mainModel[[3]],
    mainModel[[2]]
  ) %>%
  .[1,]
# nls(
#     formula = mainModel,
#     data = 
#     start = start
#  )
```
