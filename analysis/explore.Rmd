---
title: "Osa data exploration"
output:
  html_notebook:
    toc: yes
    code_folding: hide
    theme: spacelab
    fig_caption: yes
---

```{r setup}
library(knitr); opts_chunk$set(echo=F, include=F)
library(here); source(here("analysis/stats.R")); plotVarsTbl; plotVarsTbl$vardata
library(ggbeeswarm) #quasirandom()
library(ggpmisc) #stat_poly_eq()
library(ggpubr) #ggarrange()
```

# Results

## Shade and slope; stems

```{r stats}
plotVarsStatTbl <- plotVarsTbl %>%
  mutate(statTest = map(.x = vardata,
                        .f = ~ .x %>% lm(formula = median ~ dist))) %>%
  mutate(normalTest = map(.x = statTest, #needstatcol1st
                         .f = ~ .x %>% residuals() %>% shapiro_test()),
         varianceTest = map(.x = vardata, #OGdata
                            .f = ~ .x %>%
                              levene_test(formula = median ~ as.factor(dist))),
         statPrint = map(.x = statTest, .f = ~ .x %>% summary())) %>% #orglast
  mutate(isNormal = map(.x = normalTest,
                        .f = ~ if_else(.x$p.value > 0.05, T, F)),
         isHomosced = map(.x = varianceTest,
                          .f = ~ if_else(.x$p > 0.05, T, F))) %>%
  unnest(cols = c(isNormal, isHomosced)) %>% #nowlogicalnotlist
  mutate(isModelOK = if_else(isNormal && isHomosced, T, F)) %>%
  mutate(isSignif = map_if(.x = statPrint, .p = isModelOK,
                           .f = ~ if_else(.x$coefficients[[8]] < 0.05, #p
                                          true = T, false = F))) %>%
  unnest(cols = isSignif)
plotVarsStatTbl; plotVarsStatTbl$isSignif
```

```{r graphs}
plotVarsGraphTbl <- plotVarsStatTbl %>%
  mutate(graph = map(.x = vardata,
                     .f = ~ .x %>%
                       ggplot(aes(x = dist, y = median)) +
                       geom_quasirandom() +
                       geom_smooth(method = "lm") +
                       stat_poly_eq(formula = y ~ x, parse = T,
                                    aes(label = stat(..p.value.label..)))))
plotVarsGraphTbl$graph #%>% ggarrange(.[[1]], .[[2]]) #buggy
```

## Edge effects

```{r biomass}
treeVarsResultTbl <- treeVarsTbl %>%
  mutate(statTest = map(.x = vardata, 
                        .f = ~ .x %>% lm(formula = median ~ dist))) %>%
  mutate(normality = map(.x = statTest, 
                         .f = ~ .x %>% residuals() %>% shapiro_test()),
         variance = map(.x = vardata, #OGdata
                        .f = ~ .x %>%
                          levene_test(formula = median ~ as.factor(dist))),
         statVals = map(.x = statTest,.f = ~ .x %>% summary())) %>%
  mutate(signif = map(.x = statVals,
                      .f = ~ if_else(condition = .x$coefficients[[8]] < 0.05, #p
                                     true = T, false = F))) %>%
                                     unnest(cols = signif)
```
