---
title: "Osa data exploration"
output:
  html_notebook:
    toc: yes
    code_folding: hide
    theme: spacelab
    fig_caption: yes
---

```{r setup}
library(knitr); opts_chunk$set(echo=F)
library(here);source(here("analysis/stats.R"));plotVarsTbl$varData[[1]]
library(tidymodels)
library(ggbeeswarm) #quasirandom()
library(ggpmisc) #stat_poly_eq()
library(ggpubr) #ggarrange()
source(here("analysis/disfit.R")) #disfit()
library(vegan)
```

# Results

## Shade, *biomass*, *richness*

```{r plots}
mainModel <- median ~ dist
plotResultsTbl <- plotVarsTbl %>%
    mutate("statTest" = varData %>% 
             modify(~ linear_reg() %>% set_engine("lm") %>% 
                      fit(mainModel, data = .x) %>% tidy()),
           normalTest = statTest %>% 
             modify(~ .x %>% residuals() %>% shapiro_test()), #bug-tidymodel
           varianceTest = varData %>% #OGdata
             modify(~ .x %>% levene_test(formula = median ~ as.factor(dist))),
           statPrint = statTest %>% modify(~ .x %>% summary()), #orglast
           "isNormal" = normalTest %>% modify(~ if_else(.x$p.value > 0.05,T,F)),
           "isHomosced" = varianceTest %>% 
             modify(~ if_else(.x$p > 0.05, T, F))) %>%
    unnest(c(isNormal, isHomosced)) %>% #logical,!list
    mutate("isModelOK" = if_else(isNormal & isHomosced, T, F),
           "isSignif" = statPrint %>% 
             modify_if(isModelOK, ~ if_else(.x$coefficients[[8]] < 0.11, T, F),
                    .else = ~ NA)) %>% unnest(isSignif) %>%
  #nonnormalstats
  mutate("statTestPois" = varData %>% 
           modify_if(!isModelOK, 
                     ~ .x %>% glm(formula = mainModel, family = poisson()) %>%
                       summary(), .else = ~ NA),
         "statTestGamma" = varData %>% 
           modify_if(!isModelOK, 
                     ~ .x %>% glm(formula = mainModel, family = Gamma()) %>%
                       summary(), .else = ~ NA), #nestedmodifyishard
         poisAIC = statTestPois %>% modify_if(!isModelOK, ~ .x$aic),
         gammaAIC = statTestGamma %>% modify_if(!isModelOK, ~ .x$aic),
         poisPval = statTestPois %>% 
           modify_if(!isModelOK, ~ .x$coefficients[[8]]),
         gammaPval = statTestGamma %>% 
           modify_if(!isModelOK, ~ .x$coefficients[[8]])) %>% 
  unnest(c(poisAIC, gammaAIC, poisPval, gammaPval)) %>%
  mutate("pickAIC" = pmin(poisAIC, gammaAIC)) %>%
  mutate(graph = varData %>% 
           modify(~ .x %>% ggplot(aes(x = dist, y = median)) +
                    geom_quasirandom() + geom_smooth(method = "lm") +
                    stat_poly_eq(formula = y ~ x, parse = T,
                                 aes(label = stat(..p.value.label..)))))
plotResultsTbl; plotResultsTbl$graph #ggarrange(.[[1]], .[[2]]) #buggy
```

-   spg et al. vars at tree or plot level?
-   otherwise richness, spg appear signif

## Trees

```{r trees}
treeVarsTbl$varData[[1]]
mainModel1 <- median1 ~ dist
treeResultsTbl <- treeVarsTbl %>%
  mutate("statTest" = varData %>% modify(~ .x %>% lm(formula = mainModel1)),
         normalTest = statTest %>% 
           modify(~ .x %>% residuals() %>% shapiro_test()),
         varianceTest = varData %>% #OGdata
           modify(~ .x %>% levene_test(formula = median1 ~ as.factor(dist))),
         statPrint = statTest %>% modify(~ .x %>% summary()), #orglast
         "isNormal" = normalTest %>% modify(~ if_else(.x$p.value > 0.05, T, F)),
         "isHomosced" = varianceTest %>% 
           modify(~ if_else(.x$p > 0.05, T, F))) %>%
  unnest(c(isNormal, isHomosced)) %>% #logical,!list
  mutate("isModelOK" = if_else(isNormal & isHomosced, T, F),
         "isSignif" = statPrint %>% 
           modify_if(isModelOK, ~ if_else(.x$coefficients[[8]] < 0.11, T, F),
                     .else = ~ NA)) %>% unnest(isSignif) %>%
  #nonnormalstats
  mutate("statTestPois" = varData %>% 
           modify_if(!isModelOK, 
                     ~ .x %>% glm(formula = mainModel1, family = poisson()) %>%
                       summary(), .else = ~ NA),
         "statTestGamma" = varData %>% 
           modify_if(!isModelOK, 
                     ~ .x %>% glm(formula = mainModel1, family = Gamma()) %>%
                       summary(), .else = ~ NA), #nestedmodifyishard
         poisAIC = statTestPois %>% modify_if(!isModelOK, ~ .x$aic),
         gammaAIC = statTestGamma %>% modify_if(!isModelOK, ~ .x$aic),
         poisPval = statTestPois %>% 
           modify_if(!isModelOK, ~ .x$coefficients[[8]]),
         gammaPval = statTestGamma %>% 
           modify_if(!isModelOK, ~ .x$coefficients[[8]])) %>% 
  unnest(c(poisAIC, gammaAIC, poisPval, gammaPval)) %>%
  mutate("pickAIC" = pmin(poisAIC, gammaAIC)) %>%
  mutate(graph = varData %>% 
           modify(~ .x %>% ggplot(aes(x = dist, y = median1)) +
                    geom_quasirandom() + geom_smooth(method = "lm") +
                    stat_poly_eq(formula = y ~ x, parse = T,
                                 aes(label = stat(..p.value.label..)))))
#nonormalmetrics #paused
treeResultsTbl1 <- treeResultsTbl %>%
  mutate(hist = varData %>% modify(~ hist(.x$median, plot = F)),
         histTbl = hist %>%
           modify(~ tibble(value = .x$mids, f = .x$counts, d = varData$dist)),
         histgraphs = varData %>%
           modify(~ .x %>% ggplot(aes(x = median)) +
                    stat_bin(geom = "point"),
         probs = hists %>% modify(~ disfit(.x$counts + 1))) #1min/variable
treeResultsTbl1$histgraphs
treeResultsTbl1$probs

treeResultsTbl; treeResultsTbl$graph #ggarrange(.[[1]], .[[2]]) #buggy
plot(treeResultsTbl$hists[[1]]$mids, treeResultsTbl$hists[[1]]$counts)
```

-   spg appears signif--explanation will be relevant
-   explore historgrams for non-sig vars? (i.e. non-equilibrium stats)

```{r biomass}

```

## Taxa

```{r entropy}
treeVarsTbl %>%
  mutate(spTbl = varData %>% 
           modify(~ .x %>% pivot_wider(names_from = gen, values_from = median)))
```

# Discussion

-   spg and richness change likely reflects shift in community (--\> add NMDS/PCoA, with closer plots dominated by pioneering species in dense stands
-   i think inference about dispersal strategies could be in discussion, or later figure, no need to be oriiginally embedded in analysis -- but would probably make story more ecological, and study more unique to presen, though
